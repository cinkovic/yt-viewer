<body>
    <div id="inputForm">
        <input type="text" id="youtubeLink" placeholder="Enter YouTube video link..">
        <button id="submitButton">Watch</button>
        <button id="clearButton">Clear</button>
    </div>
    <ul id="history"></ul>
    <div class="popup" id="popup">
        <iframe id="popup-frame" src="" frameborder="0" allowfullscreen allow="autoplay"></iframe>
    </div>

    <script>
        const MAX_COOKIE_SIZE = 3920; // less contingency 
        const MAX_ENTRIES = 250;
        const CHECK_INTERVAL_MS = 3600000;
        const baseUrl = 'https://www.youtube.com';
        const historyList = document.getElementById('history');

        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)};${expires};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookies = decodedCookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let c = cookies[i].trim();
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return "";
        }

        function trimToFitMaxSize(videoLinks) {
            videoLinks = videoLinks.slice(0, MAX_ENTRIES);
            while (encodeURIComponent(JSON.stringify(videoLinks)).length > MAX_COOKIE_SIZE) {
                videoLinks.pop();
            }
            return videoLinks;
        }

        async function getVideoLinks() {
            const localStorageLinks = JSON.parse(localStorage.getItem('videoLinks')) || [];
            const cookieLinks = JSON.parse(getCookie('videoLinks') || '[]');
            
            const uniqueLinks = new Set([...localStorageLinks, ...cookieLinks]);

            return trimToFitMaxSize([...uniqueLinks]);
        }

        async function renderHistory() {
            const videoLinks = await getVideoLinks();
        
            // Show skeletons
            historyList.innerHTML = '';
            videoLinks.forEach(() => {
                const skeletonLi = document.createElement('li');
                skeletonLi.classList.add('skeleton');
                skeletonLi.style.height = '60px'; // Adjust height as needed
                historyList.appendChild(skeletonLi);
            });
        
            const listItems = [];
            for (let index = 0; index < videoLinks.length; index++) {
                const videoId = videoLinks[index];
                const title = await getVideoTitle(videoId);
                const thumbnailUrl = getThumbnailUrl(videoId);
        
                const li = document.createElement('li');
                li.innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail" class="thumbnail"> <span class="video-title">${title}</span> <div class="play-icon"></div> <div class="delete-icon"></div>`;
                li.dataset.index = index;
                listItems.push(li);
            }

            // Replace skeletons with actual content
            historyList.innerHTML = '';
            listItems.forEach(item => historyList.appendChild(item));
        }

        async function saveLink(videoId) {
            let videoLinks = await getVideoLinks();
            videoLinks = [videoId, ...videoLinks.filter(id => id !== videoId)];
            videoLinks = trimToFitMaxSize(videoLinks);
            try {
                setCookie('videoLinks', JSON.stringify(videoLinks), 30);
                localStorage.setItem('videoLinks', JSON.stringify(videoLinks));
                await renderHistory();
            } catch (error) {
                console.error('Error saving link:', error);
            }
        }

        const videoTitleCache = {}; // In-memory cache for video titles

        async function getVideoTitle(videoId) {
            // Check the cache first
            if (videoTitleCache[videoId]) {
                return videoTitleCache[videoId];
            }

            // If not cached, fetch and store the title
            const url = `${baseUrl}/oembed?url=${baseUrl}/watch?v=${videoId}&format=json`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error fetching title: ${response.statusText}`);
                }
                const data = await response.json();
                videoTitleCache[videoId] = data.title; // Cache the title
                return data.title;
            } catch (error) {
                console.error(error);
                return 'Error fetching title';
            }
        }
        
        async function deleteLink(index) {
            let videoLinks = await getVideoLinks();
            const deletedId = videoLinks[index];
            videoLinks.splice(index, 1);

            // Optional: Remove from cache
            delete videoTitleCache[deletedId];

            videoLinks = trimToFitMaxSize(videoLinks);

            try {
                setCookie('videoLinks', JSON.stringify(videoLinks), 30);
                localStorage.setItem('videoLinks', JSON.stringify(videoLinks));
                await renderHistory(); // Re-render the list without fetching titles again
            } catch (error) {
                console.error('Error deleting link:', error);
            }
        }

        async function getVideoTitle(videoId) {
            const url = `${baseUrl}/oembed?url=${baseUrl}/watch?v=${videoId}&format=json`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error fetching title: ${response.statusText}`);
                }
                const data = await response.json();
                return data.title;
            } catch (error) {
                console.error(error);
                return 'Error fetching title';
            }
        }

        function getThumbnailUrl(videoId) {
            return `https://img.youtube.com/vi/${videoId}/default.jpg`;
        }

        document.getElementById('submitButton').addEventListener('click', async () => {
            const youtubeLink = document.getElementById('youtubeLink').value;
            const videoId = youtubeLink.match(/(?:youtube\.com\/(?:[^\/]+\/[^\/]+\/|(?:v|e(?:mbed)?|u\/\w+\/|shorts\/|watch\?(?:.*&)?v=))|youtu\.be\/)([^#&?]*).*/i)?.[1];

            if (videoId) {
                const popupFrame = document.getElementById('popup-frame');
                popupFrame.src = `${baseUrl}/embed/${videoId}?autoplay=1`;
                document.getElementById('popup').style.display = 'flex';
                await saveLink(videoId);
            } else {
                alert('Invalid YouTube link');
            }
        });

        document.getElementById('clearButton').addEventListener('click', () => {
            const youtubeLink = document.getElementById('youtubeLink');
            youtubeLink.value = '';
            const popupFrame = document.getElementById('popup-frame');
            popupFrame.src = '';
            document.getElementById('popup').style.display = 'none';
        });

        document.getElementById('popup').addEventListener('click', () => {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('popup-frame').src = '';
        });

        historyList.addEventListener('click', (event) => {
            const li = event.target.closest('li');
            const index = parseInt(li.dataset.index, 10);
            if (event.target.classList.contains('play-icon')) {
                const videoId = getVideoLinks()[index];
                const popupFrame = document.getElementById('popup-frame');
                popupFrame.src = `${baseUrl}/embed/${videoId}?autoplay=1`;
                document.getElementById('popup').style.display = 'flex';
            } else if (event.target.classList.contains('delete-icon')) {
                event.preventDefault();
                deleteLink(index);
            }
        });

        async function trimPeriodically() {
            let videoLinks = await getVideoLinks();
            videoLinks = trimToFitMaxSize(videoLinks);
            setCookie('videoLinks', JSON.stringify(videoLinks), 30);
            localStorage.setItem('videoLinks', JSON.stringify(videoLinks));
        }

        (async () => {
            await renderHistory();
        })();
        trimPeriodically();
        setInterval(trimPeriodically, CHECK_INTERVAL_MS);
    </script>    
</body>
